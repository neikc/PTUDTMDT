
@{
    ViewData["Title"] = "CheckOut";
}
@model PTUDTMDT.ViewModels.CartViewModel.CheckOutViewModel

<div class="container-fluid py-5 mt-5">
    <!--Nếu không có sản phẩm nào-->
    @if (Model.ItemList.Any() == false)
    {
        <div class="text-center">
            <h2>Không có sản phẩm nào để thanh toán, quay về cửa hàng thôiii</h2>
            <a href="@Url.Action("ShopIndex","Shop")"
               class="btn border border-secondary rounded-pill px-3 text-primary mt-3 py-2">
                <i class="fa fa-shopping-bag me-2 text-primary"></i>Quay về cửa hàng
            </a>
        </div>
    }
    else
    {
        <!--Phần thông tin khách hàng và Tổng đơn hàng-->
        <div class="container py-5">
            <div class="row d-flex align-items-start gap-5 rounded-2xl">
                <div class="col-lg-7 col-12 shadow rounded py-4 px-4">
                    <!--Thông tin khách hàng-->
                    <form asp-action="CheckOut" asp-controller="Cart" method="post" class="w-100" id="multiPageForm">
                        <!-- Bước 1 -->
                        <div class="form-step" id="step1" style="display: block;">
                            <h2 class="d-flex justify-content-center md-3">Thông tin khách hàng</h2>

                            <!-- Họ và tên -->
                            <div class="form-group mb-4">
                                <label for="HoTen" class="form-label">Họ và tên:</label>
                                <input type="text" id="HoTen" asp-for="HoTen" class="form-control border-0 py-3" required placeholder="Nhập họ và tên" style="border-radius: 10px;"
                                       value="@Model.HoTen" readonly>
                                <span asp-validation-for="HoTen" class="text-danger"></span>
                            </div>

                            <!-- Email -->
                            <div class="form-group mb-4">
                                <label for="Email" class="form-label">Email:</label>
                                <input type="email" id="Email" asp-for="Email" class="form-control border-0 py-3" required placeholder="Nhập email" style="border-radius: 10px;"
                                       value="@Model.Email" readonly>
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>

                            <!-- Số điện thoại -->
                            <div class="form-group mb-4">
                                <label for="SoDienThoai" class="form-label">Số điện thoại:</label>
                                <input type="text" id="SoDienThoai" asp-for="SoDienThoai" class="form-control border-0 py-3" required placeholder="Nhập số điện thoại" style="border-radius: 10px;"
                                       value="@Model.SoDienThoai" readonly>
                                <span asp-validation-for="SoDienThoai" class="text-danger"></span>
                            </div>

                            <!-- Checkbox sử dụng thông tin của tôi (disable luôn) -->
                            <div class="form-group mb-4">
                                <input type="checkbox" id="Checkbox" asp-for="Checkbox" style="transform: scale(1.5);" disabled>
                                <label for="Checkbox" class="form-label">Sử dụng thông tin của tôi</label>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" onclick="nextStep(2)" style="border-radius: 10px; padding: 12px 25px;">Tiếp tục</button>
                            </div>
                        </div>

                        <!-- Bước 2 -->
                        <div class="form-step" id="step2" style="display: none;">
                            <h2 class="d-flex justify-content-center md-3">Địa chỉ giao hàng</h2>

                            <!-- Giao hàng tận nơi / Lấy tại cửa hàng -->
                            <div class="form-group mb-1">
                                <label>Phương thức giao hàng:</label><br>
                                <div class="mb-4">
                                    <input type="radio" id="Pickup" asp-for="MaGiaoHang" value="Pickup" onclick="toggleAddress(false)" style="transform: scale(1.5);">
                                    <label for="Pickup"> Lấy tại cửa hàng</label>
                                </div>
                                

                                <input type="radio" id="Delivery" asp-for="MaGiaoHang" value="Delivery" onclick="toggleAddress(true)" style="transform: scale(1.5);">
                                <label for="Delivery"> Giao hàng tận nơi</label><br>
                                <span asp-validation-for="MaGiaoHang" class="text-danger"></span>
                            </div>

                            <!-- Địa chỉ giao hàng -->
                            <div class="form-group mb-4">
                                <label for="DiaChi" class="form-label">Địa chỉ:</label>
                                <input type="text" id="DiaChi" asp-for="DiaChi" class="form-control border-1 py-3" placeholder="@Model.DiaChi" disabled style="border-radius: 10px;">
                                <span asp-validation-for="DiaChi" class="text-danger"></span>
                            </div>

                            <!-- Ghi chú -->
                            <div class="form-group mb-4">
                                <label for="GhiChu" class="form-label">Ghi chú:</label>
                                <textarea id="GhiChu" asp-for="GhiChu" class="form-control border-1 py-3" placeholder="Nhập ghi chú" rows="3" style="border-radius: 10px;"></textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(1)" style="border-radius: 10px; padding: 12px 25px;">Quay lại</button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(3)" style="border-radius: 10px; padding: 12px 25px;">Tiếp tục</button>
                            </div>
                        </div>

                        <!-- Bước 3 -->
                        <div class="form-step" id="step3" style="display: none;">
                            <h2 class="d-flex justify-content-center md-3">Phương thức thanh toán</h2>

                            <!-- Phương thức thanh toán -->
                            <div class="form-group mb-4">
                                <input type="radio" id="COD" asp-for="MaPttt" value="COD" checked style="transform: scale(1.5);">
                                <label for="COD">Thanh toán khi nhận hàng (COD)</label>
                                <span asp-validation-for="MaPttt" class="text-danger"></span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(2)" style="border-radius: 10px; padding: 12px 25px;">Quay lại</button>
                                <button type="submit" class="btn btn-success" style="border-radius: 10px; padding: 12px 25px;">Xác nhận đặt hàng</button>
                            </div>
                        </div>
                    </form>

                    <!--Script điều khiển form thông tin khách hàng-->
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            // Chuyển sang bước tiếp theo
                            window.nextStep = function (stepNumber) {
                                document.querySelectorAll('.form-step').forEach(step => step.style.display = 'none');
                                document.getElementById('step' + stepNumber).style.display = 'block';
                            };

                            // Quay lại bước trước
                            window.prevStep = function (stepNumber) {
                                document.querySelectorAll('.form-step').forEach(step => step.style.display = 'none');
                                document.getElementById('step' + stepNumber).style.display = 'block';
                            };

                            // Bật hoặc tắt trường "Địa chỉ" dựa trên lựa chọn phương thức giao hàng
                            window.toggleAddress = function (isDelivery) {
                                const addressInput = document.getElementById('DiaChi');
                                if (isDelivery) {
                                    addressInput.disabled = false;
                                    addressInput.required = true;
                                    addressInput.style.backgroundColor = ''; // Reset style nếu bị disable trước đó
                                } else {
                                    addressInput.disabled = true;
                                    addressInput.required = false;
                                    addressInput.value = ''; // Xóa giá trị nếu không sử dụng địa chỉ
                                    addressInput.style.backgroundColor = '#f8f9fa'; // Đặt màu nền khác để trông bị vô hiệu hóa
                                }
                            };
                        });
                    </script>
                </div>
                <!-- Phần thanh bên thể hiện thông tin và áp dụng mã giảm giá -->
                <div class="col-lg-4 col-12">
                    <div class="d-flex align-items-center rounded-2xl">
                        <div class="flex-column justify-content-center w-100 p-4 mt-lg-6 rounded bg-light">
                            <h2 class="mb-2">Thông tin đơn hàng</h2>
                            <p>
                                Số lượng sản phẩm
                                <span class="float-end">@Model.ItemList.Sum(x => x.Quantity)</span>
                            </p>
                            <p class="mb-2">
                                Tạm tính
                                <span class="float-end">@Model.ItemList.Sum(x => x.Total).ToString("#,0")đ</span>
                            </p>
                            <p class="mb-2">
                                Phí vận chuyển
                                <span class="float-end">0đ</span>
                            </p>
                            <p class="mb-2">
                                <b>Thành tiền</b>
                                <span class="float-end">
                                    @(Model.TongTienSauGiam.HasValue && Model.TongTienSauGiam.Value > 0
                                        ? Model.TongTienSauGiam.Value.ToString("#,0")
                                        : Model.ItemList.Sum(x => x.Total).ToString("#,0"))
                                    đ
                                </span>
                            </p>

                            @if (!string.IsNullOrEmpty(Model.MaGiamGia))
                            {
                                <div>
                                    <p>Mã giảm giá đang áp dụng: @Model.MaGiamGia</p>
                                    <form asp-action="RemoveVoucher" method="post">
                                        <button type="submit" class="btn btn-danger">Hủy mã giảm giá</button>
                                    </form>
                                </div>
                            }

                            <!--Phần form áp dụng mã giảm giá-->
                            <form asp-action="ApplyVoucher" method="post" class="mb-4 mt-3" id="voucherform">
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="text" id="MaGiamGia" name="MaGiamGia" class="form-control" placeholder="Nhập mã giảm giá" required>
                                        <button type="submit" class="btn btn-primary">Áp dụng</button>
                                    </div>
                                </div>
                            </form>

                            <!--Phần danh sách các voucher của khách hàng-->
                            <h4 class="mt-2 mb-2">Áp dụng voucher</h4>
                            <div class="container fruite">
                                @if (Model.VoucherList.Count()==0)
                                {
                                    <p>Bạn chưa có voucher nào</p>
                                }
                                else
                                {
                                    @foreach (var item in Model.VoucherList)
                                    {
                                        <div class="p-4 mt-auto border-top-0 rounded fruite-item"
                                            onclick="applyVoucher('@item.MaGiamGia')"
                                            style="background-color: white; width:100%">
                                            <div>
                                                <p class="mb-2">
                                                    @item.TenMa
                                                    <span class="text-warning">
                                                            (-@(item.GiaTri * 100)%)
                                                    </span>
                                                </p>
                                                <p class="mb-2"><strong>Mã: @item.MaGiamGia</strong></p>
                                            </div>
                                        </div>

                                        <!-- Thêm form ẩn -->
                                        <form id="voucherListForm_@item.MaGiamGia" asp-action="ApplyVoucher" method="post">
                                            <input type="hidden" id="MaGiamGiaListForm_@item.MaGiamGia" name="MaGiamGia" />
                                        </form>

                                        <!-- Thêm script -->
                                        <script>
                                            function applyVoucher(maGiamGia) 
                                            {
                                                document.getElementById('MaGiamGiaListForm_@item.MaGiamGia').value = maGiamGia;
                                                document.getElementById('voucherListForm_@item.MaGiamGia').submit();
                                            }
                                        </script>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Phần sản phẩm mua kèm-->
        <div class="container-fluid py-5">
            <div class="container">
                <h2 class="mb-1 text-start"><b>Bạn có thể mua cùng</b></h2>

                <div class="vesitable">
                    <div class="owl-carousel vegetable-carousel justify-content-center rounded">
                        @foreach (var product in Model.BestSellers)
                        {
                            <div class="vesitable-item rounded">
                                <div class="container-fluid p-4 rounded bg-light">
                                    <div class="row align-items-center">
                                        <div class="col-6">
                                            <div style="max-height:100px contain">
                                                <a href="@Url.Action("ShopDetail", "Shop", new { MaSanPham = product.MaSanPham })"></a>
                                                <img src="@Url.Content(product.LayDiaChiHinh(1))" class="img-fluid rounded-circle w-100" alt="@product.ShortDesc">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <a href="@Url.Action("ShopDetail", "Shop", new { MaSanPham = product.MaSanPham })" class="h5">@product.TenSanPham</a>
                                            <!--Đánh giá-->
                                            <div class="d-flex mb-2">
                                                @for (int i = 1; i <= product.AverageRating; i++)
                                                {
                                                    <i class="fa fa-star text-secondary"></i> <!-- Sao đầy -->
                                                }
                                                @for (int i = product.AverageRating + 1; i <= 5; i++)
                                                {
                                                    <i class="fa fa-star"></i> <!-- Sao trống -->
                                                }
                                            </div>
                                            <!-- Giá sản phẩm -->
                                            @if (product.GiaSanPham > product.GiaSauGiam)
                                            {
                                                <h5 class="fw-bold mb-3 text-danger">Giảm @product.GiamGia%!</h5>
                                                <h5 class="fw-bold mb-3"><span class="text-danger">@product.FormatPrice(product.GiaSauGiam)</span>     <span class="text-decoration-line-through">@product.FormatPrice(product.GiaSanPham)</span></h5>
                                            }
                                            else
                                            {
                                                <h5 class="fw-bold mb-3 text-danger">@product.FormatPrice(product.GiaSauGiam)</h5>
                                            }
                                            <!--Thêm vào giỏ hàng-->
                                            <a href="javascript:void(0);"
                                               onclick="document.getElementById('addToCartForm_Index3+@product.MaSanPham').submit();"
                                               class="btn border border-secondary rounded-pill px-3 text-primary">
                                                <i class="fa fa-shopping-bag me-2 text-primary"></i>Mua
                                            </a>

                                            <form id="addToCartForm_Index3+@product.MaSanPham" action="@Url.Action("AddToCart", "Cart")" method="post" style="display:none;">
                                                <input type="hidden" name="MaSanPham" value="@product.MaSanPham" />
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!--Phần sản phẩm đang Sale-->
        <div class="container-fluid py-5">
            <div class="container">
                <h2 class="mb-1 text-start"><b>Sản phẩm đang giảm giá</b></h2>
                <div class="vesitable">
                    <div class="owl-carousel vegetable-carousel justify-content-center rounded">
                        @foreach (var product in Model.OnSale)
                        {
                            <div class="border border-primary rounded position-relative vesitable-item">
                                <div class="vesitable-img">
                                    <a href="@Url.Action("ShopDetail", "Shop", new { MaSanPham = product.MaSanPham })">
                                        <img src="@Url.Content(product.LayDiaChiHinh(1))" class="img-fluid w-100 rounded-top" style="max-height:305px; object-fit: contain" alt="@product.ShortDesc">
                                </div>
                                <div class="text-white bg-primary px-3 py-1 rounded position-absolute" style="top: 10px; right: 10px;">@product.MaLoaiNavigation.TenLoai</div>
                                <div class="p-4 pb-0 rounded-bottom">
                                    <a href="@Url.Action("ShopDetail", "Shop", new { MaSanPham = product.MaSanPham })" class="text-dark">
                                        @product.TenSanPham
                                    </a>
                                    <p>@product.ShortDesc</p>
                                    <div class="d-flex justify-content-between align-items-end flex-lg-wrap">
                                        <!--FormatPrice chuyển từ số sang định dạng tiền tệ, hàm này viết thêm trong Model Sanpham-->
                                        <!-- Giá sản phẩm -->
                                        <h5 class="fw-bold me-2">@product.FormatPrice(product.GiaSauGiam)</h5>
                                        @if (product.GiaSanPham > product.GiaSauGiam)
                                        {
                                            <h5 class="text-danger">
                                                <span class="text-decoration-line-through">@product.FormatPrice(product.GiaSanPham)</span>
                                                (-@product.GiamGia%)
                                            </h5>
                                        }
                                    </div>
                                    <a href="javascript:void(0);"
                                       style="margin-bottom:1em; padding-top:1em; padding-bottom:1em"
                                       onclick="document.getElementById('addToCartForm_ShopDetail').submit();"
                                       class="btn border border-secondary rounded-pill px-3 text-primary">
                                        <i class="fa fa-shopping-bag me-2 text-primary"></i>Thêm vào giỏ hàng
                                    </a>

                                    <form id="addToCartForm_ShopDetail" action="@Url.Action("AddToCart", "Cart")" method="post" style="display:none;">
                                        <input type="hidden" name="MaSanPham" value="@product.MaSanPham" />
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
